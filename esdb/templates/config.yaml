apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "esdb.fullname" $}}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "esdb.labels" . | nindent 4 }}
data:
# Setup config, generate gossip seeds & add custom config
# This file will become the YAML configuration file for eventstore
{{- range $i, $e := until (.Values.deployment.clusterSize | int) }}
  '{{ include "esdb.fullname" $}}-{{ $i }}': |
    ExtIp: 0.0.0.0
    IntIp: 0.0.0.0

    Db: /data/db
    Log: /data/logs
    
    ClusterSize: {{ $.Values.deployment.clusterSize }}
    TrustedRootCertificatesPath: /certs/ca
    CertificateFile: /certs/node/{{ include "esdb.fullname" $}}-{{ $i }}.crt
    CertificatePrivateKeyFile: /certs/node/{{ include "esdb.fullname" $}}-{{ $i }}.key
    
    AdvertiseHostToClientAs: {{ (index $.Values.deployment.hosts ($i | toString)) }}

    IntHostAdvertiseAs: {{ include "esdb.fullname" $ }}-{{ $i }}
    ExtHostAdvertiseAs: {{ include "esdb.fullname" $ }}-{{ $i }}
    
    {{- $gossipSeeds := list}}
    {{- range $iInner, $eInner := until ($.Values.deployment.clusterSize | int) }}
    {{- if ne $iInner $i }}
      {{- $gossipSeeds = append $gossipSeeds (print (include "esdb.fullname" $) "-" $iInner ":2113") }}
    {{- end }}
    {{- end }}
    
    DiscoverViaDns: false
    GossipSeed: {{ $gossipSeeds | join "," }}
    
    AdvertiseHttpPortToClientAs: 443
    
    {{/*Shared config*/}}
    {{- toYaml $.Values.deployment.config.shared | nindent 4}}

    {{/* Node config*/}}
    {{- with index $.Values.deployment.config ($i | toString) }}
    {{- toYaml . | nindent 4}}
    {{- end }}


  {{- if $.Values.backup.enable }}
  '{{ include "esdb.fullname" $}}-{{ $i }}-backup': |
    {
      "Authentication": {
        "EventStoreServer": "https://localhost:2113/"
      },
      "Backup": {
        "ServerName": "{{ (index $.Values.deployment.hosts ($i | toString)) }}",
        "DataDirectory": "/data/db",
        "TempDirectory": "/tmp"
      },
      "Kestrel": {
        "Endpoints": {
          "Https": {
            "Url": "https://+:443/",
            "Certificate": {
              "Path": "/certs/node/{{ include "esdb.fullname" $}}-{{ $i }}.crt",
              "KeyPath": "/certs/node/{{ include "esdb.fullname" $}}-{{ $i }}.key"
            }
          }
        }
      }
    } 
  {{- end }}

{{- end}}

